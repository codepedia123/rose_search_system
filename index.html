<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <script src="https://thunkable.github.io/webviewer-extension/thunkableWebviewerExtension.js" type="text/javascript"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dynamic Page with Thunkable Integration</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap');

    /* Global Styles */
    body {
      font-family: 'Montserrat', sans-serif;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      height: 100vh;
      margin: 0;
      background-color: #ffffff;
      overflow: hidden;
    }

    /* Horizontally scrollable container for filters */
    .filter-scroll-container {
      width: 100%;
      overflow-x: auto;
      white-space: nowrap;
      display: flex;
      gap: 10px;
      padding: 10px;
      box-sizing: border-box;
      background-color: #f7f7f7;
    }

    /* Filter Button Styles (default) */
    .filter-scroll-container button {
      border: 1px solid black;
      padding: 8px 14px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: normal;
      cursor: pointer;
      background-color: white;
      color: black;
      white-space: nowrap;
      outline: none;
    }

    .filter-scroll-container button:hover {
      background-color: #eaeaea;
    }

    /* Slider & Slides */
    .slider {
      width: 100%;
      height: 100vh;
      overflow: hidden;
      position: relative;
    }

    .slides {
      overflow-y: scroll;
      height: calc(100% - 60px);
      padding: 20px 10px;
      box-sizing: border-box;
    }

    .slide {
      width: calc(100% - 20px);
      padding: 20px;
      text-align: left;
      box-sizing: border-box;
      border-radius: 30px;
      margin: 20px 10px;
      cursor: pointer;
    }

    /* Example background colors for multiple slides */
    .slide:nth-child(1) { background-color: #FFF8E7; }
    .slide:nth-child(2) { background-color: #E6F7FF; }
    .slide:nth-child(3) { background-color: #E6FFE6; }
    .slide:nth-child(4) { background-color: #F5E6FF; }
    .slide:nth-child(5) { background-color: #FFE6E6; }
    .slide:nth-child(6) { background-color: #FFEFD5; }
    .slide:nth-child(7) { background-color: #FFFFE0; }
    .slide:nth-child(8) { background-color: #E0FFFF; }
    .slide:nth-child(9) { background-color: #F0E68C; }

    .slide h2 {
      font-size: 16px;
      font-weight: 600;
      margin: 0 0 5px;
    }

    .slide p {
      font-size: 12px;
      font-weight: 400;
      margin: 5px 0;
      display: flex;
      align-items: center;
    }

    .slide .icon {
      display: inline-block;
      width: 16px;
      height: 16px;
      margin-right: 10px;
      vertical-align: middle;
      background-size: cover;
    }

    .icon-location {
      background-image: url('https://res.cloudinary.com/di751ehfz/image/upload/v1722218141/mp-removebg-preview_ikwqdz.png');
    }
    .icon-clock {
      background-image: url('https://res.cloudinary.com/di751ehfz/image/upload/v1722218138/circ-removebg-preview_jlvmsy.png');
    }
    .icon-dyslexia {
      background-image: url('https://res.cloudinary.com/di751ehfz/image/upload/v1722218136/puzle-removebg-preview_oguelc.png');
    }

    .slide .price {
      display: inline-block;
      padding: 8px 16px;
      background-color: #ff9999;
      border-radius: 100px;
      font-weight: 600;
      color: #000;
      font-size: 14px;
      margin-top: 10px;
    }

    /* Popup Overlay & Popup */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
    }

    .popup {
      background: #fff;
      border-radius: 20px;
      padding: 20px;
      width: 300px;
      box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.2);
      position: relative;
      text-align: left;
    }

    .popup h2 {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
    }

    .popup p {
      margin: 5px 0;
      font-size: 14px;
      display: flex;
      align-items: center;
    }

    .popup .icon {
      width: 16px;
      height: 16px;
      margin-right: 10px;
      vertical-align: middle;
      background-size: cover;
    }

    .popup .price-tag {
      display: inline-block;
      padding: 5px 10px;
      background-color: #ff9999;
      border-radius: 15px;
      color: #fff;
      font-weight: bold;
      margin-top: 10px;
      font-size: 14px;
    }

    .popup p.description {
      font-size: 12px;
      font-weight: 300;
      opacity: 0.8;
      color: #333;
      display: block;
      margin-top: 5px;
    }

    .popup .close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      color: #333;
    }

    /* Star (Save) Button */
    .star-button {
      position: absolute;
      top: 12px; 
      right: 50px;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    /* Popup Buttons */
    .popup .button {
      padding: 8px 16px;
      border-radius: 20px;
      margin: 10px 5px 0;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      text-decoration: none;
      color: #fff;
      text-align: center;
      display: inline-block;
    }

    .view-org {
      background-color: #7A68EB;
    }
    .view-website {
      background-color: #33CF90;
    }

    /* Active filter style (remove border, light gray background) */
    .filter-active {
      background-color: #d3d3d3 !important;
      border: none !important;
    }
  </style>
</head>
<body>

<!-- FILTER BUTTONS (Horizontally scrollable) -->
<div class="filter-scroll-container">
  <!-- Each button has an ID so we can update styles dynamically -->
  <button id="btnPriceHigh" onclick="toggleFilter('priceHighToLow')">Price: Highest to Lowest</button>
  <button id="btnPriceLow" onclick="toggleFilter('priceLowToHigh')">Price: Lowest to Highest</button>
  <button id="btnDateSoonest" onclick="toggleFilter('dateSoonest')">Date: Soonest</button>
  <button id="btnDateFurthest" onclick="toggleFilter('dateFurthest')">Date: Furthest</button>
</div>

<div class="slider">
  <div class="slides" id="slides">
    <!-- Slides will be dynamically added by JavaScript -->
  </div>
</div>

<!-- POPUP OVERLAY -->
<div class="popup-overlay" id="popupOverlay">
  <div class="popup" id="popup">
    <!-- Close Button -->
    <span class="close-btn" onclick="closePopup()">Ã—</span>
    <!-- Star (Save) Button -->
    <img 
      id="starButton" 
      class="star-button" 
      src="https://res.cloudinary.com/di751ehfz/image/upload/v1739370280/star_bxmhkq.png" 
      onclick="toggleSaved()" 
    />

    <h2 id="popupTitle">Workshop Title</h2>
    <p><a href="#" id="popupOrganization">Organization Name</a></p>
    <p><span class="icon icon-dyslexia"></span><span id="popupTopic">SEN NAME</span></p>
    <p><span class="icon icon-clock"></span><span id="popupTime">Date & Time</span></p>
    <p><span class="icon icon-location"></span><span id="popupLocation">Location</span></p>
    <!-- Description ONLY in popup -->
    <p class="description" id="popupDescription"></p>

    <div class="price-tag" id="popupPrice">$200</div>
    <!-- Extra Buttons inside popup -->
    <a href="#" class="button view-org" onclick="postMessage('View Organisation')">View Organisation</a>
    <a href="#" class="button view-website" onclick="postMessage('View Website')">View Website</a>
  </div>
</div>

<script>
  // References to filter buttons for easy style updating
  const filterButtons = {
    priceHighToLow: document.getElementById("btnPriceHigh"),
    priceLowToHigh: document.getElementById("btnPriceLow"),
    dateSoonest: document.getElementById("btnDateSoonest"),
    dateFurthest: document.getElementById("btnDateFurthest")
  };

  const slidesContainer = document.getElementById('slides');
  let targetLang = 'en';               // Default language
  let slideDataOriginal = [];          // Original data (unfiltered)
  let translatedDataOriginal = [];     // Translated data in parallel
  let slideData = [];                  // Currently displayed data after filters
  let translatedData = [];             // Parallel array for displayed translations

  let activeFilters = [];              // Track active filter names
  let savedIDs = [];                   // IDs that are currently saved
  let currentPopupID = null;           // The ID of the workshop in the popup

  // ---------------------- Utilities ---------------------- //
  // Parse date in format DD/MM/YYYY to a Date object for sorting
  function parseDDMMYYYY(dateStr) {
    if (!dateStr || typeof dateStr !== 'string') {
      return new Date('1970-01-01'); // fallback
    }
    const [day, month, year] = dateStr.split('/');
    return new Date(`${year}-${month}-${day}`);
  }

  // Convert "DD/MM/YYYY" + "Time" => "13 February 2025 10:00 AM - 11:00 AM"
  function formatDateTime(dateStrDDMMYYYY, timeStr) {
    if (!dateStrDDMMYYYY) return timeStr; // fallback
    const [day, month, year] = dateStrDDMMYYYY.split('/');
    const dayNum = Number(day);
    const monthNum = Number(month);
    const yearNum = Number(year);

    const monthNames = [
      "January","February","March","April","May","June",
      "July","August","September","October","November","December"
    ];
    const monthName = monthNames[monthNum - 1] || "Unknown";

    return `${dayNum} ${monthName} ${yearNum} ${timeStr}`;
  }

  // ---------------------- Translation API ---------------------- //
  const translationAPIUrl = "https://script.google.com/macros/s/AKfycbyOjmRSRhbTQ4HEHnR5yAb5eoNQJn2t80yvmdX03uYZzqUXqCPnZ0AjTaAEgNcleyBM/exec";

  // Translate or skip if targetLang = 'en'
  function translateSlides(data) {
    // Keep the original data
    slideDataOriginal = data;

    if (data.length === 0) {
      slidesContainer.innerHTML = "<p style='color: grey; font-size: 14px; text-align: center;'>No Recommendations</p>";
      return;
    }

    // If invalid target language, skip
    if (!targetLang || targetLang.trim() === '') {
      console.error("Target language is missing or invalid.");
      return;
    }

    // If language is English, skip calling API
    if (targetLang === 'en') {
      translatedDataOriginal = data.map(item => ({ ...item })); // clone
      applyAllFilters();
    } else {
      // Prepare pipe-delimited string for each workshop
      const csvData = data.map(item =>
        `${item.title}|${item.organization}|${item.topic}|${item.time}|${item.location}|${item.price}|${item.description}`
      ).join("\n");

      const url =
        `${translationAPIUrl}?text=${encodeURIComponent(csvData)}&source=en&target=${encodeURIComponent(targetLang)}`;

      fetch(url)
        .then(response => response.text())
        .then(translatedText => {
          const rows = translatedText.split("\n");
          translatedDataOriginal = rows.map(line => {
            const [title, organization, topic, time, location, price, description] = line.split("|");
            return {
              title: title || "",
              organization: organization || "",
              topic: topic || "",
              time: time || "",
              location: location || "",
              price: price || "",
              description: description || ""
            };
          });
          applyAllFilters();
        })
        .catch(error => {
          console.error("Translation API Error:", error);
        });
    }
  }

  // ---------------------- Filter Logic ---------------------- //
  function applyAllFilters() {
    // Start with full original data
    let combined = slideDataOriginal.map((orig, i) => ({
      original: orig,
      translated: translatedDataOriginal[i]
    }));

    // Apply each filter in the order they are active
    activeFilters.forEach(filter => {
      if (filter === 'priceHighToLow') {
        combined.sort((a, b) => b.original.price - a.original.price);
      } else if (filter === 'priceLowToHigh') {
        combined.sort((a, b) => a.original.price - b.original.price);
      } else if (filter === 'dateSoonest') {
        combined.sort((a, b) => parseDDMMYYYY(a.original.Date) - parseDDMMYYYY(b.original.Date));
      } else if (filter === 'dateFurthest') {
        combined.sort((a, b) => parseDDMMYYYY(b.original.Date) - parseDDMMYYYY(a.original.Date));
      }
    });

    // Extract final arrays after sorting
    slideData = combined.map(item => item.original);
    translatedData = combined.map(item => item.translated);

    // Update on screen
    updateSlidesContent(translatedData, slideData);
  }

  // Toggle filter in activeFilters and update UI + slides
  function toggleFilter(filterName) {
    if (activeFilters.includes(filterName)) {
      // Remove if already present
      activeFilters = activeFilters.filter(f => f !== filterName);
    } else {
      // Add if not present
      activeFilters.push(filterName);
    }

    // Update button style
    updateFilterButtonStyles();
    // Re-apply filters
    applyAllFilters();
  }

  // Update button styles based on activeFilters
  function updateFilterButtonStyles() {
    // For each known filter, check if it's active
    Object.entries(filterButtons).forEach(([filterKey, button]) => {
      if (activeFilters.includes(filterKey)) {
        button.classList.add('filter-active');
      } else {
        button.classList.remove('filter-active');
      }
    });
  }

  // ---------------------- Slide & Popup Rendering ---------------------- //
  function updateSlidesContent(tData, oData) {
    slidesContainer.innerHTML = ""; // clear

    tData.forEach((item, index) => {
      const slide = document.createElement("div");
      slide.className = "slide";

      const dateTimeStr = formatDateTime(oData[index].Date, item.time);

      slide.onclick = () => {
        // Show popup
        showPopup(item, oData[index].Date, oData[index].id);
      };

      slide.innerHTML = `
        <h2>${item.title}</h2>
        <p><span style="color: #3498db;"><strong>${item.organization}</strong></span></p>
        <p><span class="icon icon-dyslexia"></span>${item.topic}</p>
        <p><span class="icon icon-clock"></span>${dateTimeStr}</p>
        <p><span class="icon icon-location"></span>${item.location}</p>
        <div class="price">${item.price}</div>
      `;
      slidesContainer.appendChild(slide);
    });
  }

  function showPopup(data, dateStr, idValue) {
    currentPopupID = idValue;
    document.getElementById("popupTitle").innerText = data.title;
    document.getElementById("popupOrganization").innerText = data.organization;
    document.getElementById("popupTopic").innerText = data.topic;
    document.getElementById("popupTime").innerText = formatDateTime(dateStr, data.time);
    document.getElementById("popupLocation").innerText = data.location;
    document.getElementById("popupPrice").innerText = data.price;
    document.getElementById("popupDescription").innerText = data.description;

    // Update star icon
    updateStarIcon();

    document.getElementById("popupOverlay").style.display = "flex";
  }

  function closePopup() {
    currentPopupID = null;
    document.getElementById("popupOverlay").style.display = "none";
  }

  // ---------------------- Saving / Star Button ---------------------- //
  function updateStarIcon() {
    const starImg = document.getElementById("starButton");
    if (!currentPopupID) return;
    if (savedIDs.includes(String(currentPopupID))) {
      // Saved
      starImg.src = "https://res.cloudinary.com/di751ehfz/image/upload/v1739370280/star_1_ndcskw.png";
    } else {
      // Unsaved
      starImg.src = "https://res.cloudinary.com/di751ehfz/image/upload/v1739370280/star_bxmhkq.png";
    }
  }

  function toggleSaved() {
    if (!currentPopupID) return;
    const strID = String(currentPopupID);

    // If already saved, remove it
    if (savedIDs.includes(strID)) {
      savedIDs = savedIDs.filter(id => id !== strID);
    } else {
      // Otherwise, add it
      savedIDs.push(strID);
    }
    // Update icon immediately
    updateStarIcon();

    // Send updated saved IDs list to Thunkable (prefix "?")
    postMessage("?" + savedIDs.join(","));
  }

  // ---------------------- Thunkable Messaging ---------------------- //
  function postMessage(mess) {
    ThunkableWebviewerExtension.postMessage(mess);
  }

  function updateSlidesFromJSON(jsonData) {
    const dataObj = (typeof jsonData === 'string') ? JSON.parse(jsonData) : jsonData;
    if (!dataObj || !Array.isArray(dataObj.data)) {
      console.error("Invalid JSON format: Expected { data: [...] }");
      return;
    }

    // Map input to consistent shape
    const data = dataObj.data.map(item => ({
      id: item.ID,
      title: String(item.Name),
      organization: String(item.organization || `Org #${item.OrgID}`),
      topic: item.SEN,
      time: item.Time,
      location: item.Location,
      price: Number(item.Price),
      Date: item.Date || "",
      description: item.Description ? String(item.Description) : ""
    }));

    // Translate or display immediately
    translateSlides(data);
  }

  // Listen for messages from Thunkable
  ThunkableWebviewerExtension.receiveMessage(function(message) {
    console.log("Received message:", message);
    try {
      // If message starts with "*" => language change
      if (message.startsWith("*")) {
        targetLang = message.slice(1);
        console.log("Language changed to:", targetLang);
        if (slideDataOriginal && slideDataOriginal.length > 0) {
          translateSlides(slideDataOriginal);
        }
      }
      // If message starts with "?" => saved ID list
      else if (message.startsWith("?")) {
        const savedStr = message.substring(1).trim();
        savedIDs = savedStr ? savedStr.split(",") : [];
        // If a popup is open, refresh star icon
        updateStarIcon();
      }
      // Otherwise, treat as JSON data
      else {
        updateSlidesFromJSON(message);
      }
    } catch (error) {
      console.error("Error processing received message:", error);
    }
  });
</script>

<!-- Optional: remove if not needed -->
<script
  defer
  src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015"
  integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ=="
  data-cf-beacon='{"rayId":"8f4bef66ca9659e4","serverTiming":{"name":{"cfExtPri":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2024.10.5","token":"ef0548ffc9904e66b75bcd9134981ca0"}'
  crossorigin="anonymous">
</script>

</body>
</html>



